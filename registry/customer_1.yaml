product: customer
version: v1
namespace: telco.silver

entities:
  - name: customer_profile
    table: customer_profile_v1
    primary_key: customer_id
    fields:
      - { name: customer_id, type: STRING }
      - { name: full_name, type: STRING }
      - { name: primary_email, type: STRING }
      - { name: phone, type: STRING }
      - { name: country, type: STRING }
      - { name: segment, type: STRING }
      - { name: status, type: STRING }
      - { name: created_at, type: TIMESTAMP }
      - { name: updated_at, type: TIMESTAMP }

  - name: customer_accounts
    table: customer_accounts_v1
    primary_key: account_id
    fields:
      - { name: account_id, type: STRING }
      - { name: customer_id, type: STRING }
      - { name: plan_code, type: STRING }
      - { name: billing_cycle_day, type: INT }
      - { name: status, type: STRING }
      - { name: created_at, type: TIMESTAMP }
      - { name: updated_at, type: TIMESTAMP }

  - name: customer_subscriptions
    table: customer_subscriptions_v1
    primary_key: subscription_id
    fields:
      - { name: subscription_id, type: STRING }
      - { name: account_id, type: STRING }
      - { name: product_id, type: STRING }
      - { name: status, type: STRING }
      - { name: start_date, type: DATE }
      - { name: end_date, type: DATE }
      - { name: created_at, type: TIMESTAMP }
      - { name: updated_at, type: TIMESTAMP }

relationships:
  - { from: customer_profile, to: customer_accounts, type: "ONE_TO_MANY", via: customer_id }
  - { from: customer_accounts, to: customer_subscriptions, type: "ONE_TO_MANY", via: account_id }

expose:
  queries:
    - get_customer: { entity: customer_profile, by_key: customer_id }
    - list_customers:
        entity: customer_profile
        filters:
          - { name: country, type: STRING, operator: "=" }
          - { name: status, type: STRING, operator: "=" }
          - { name: q, type: STRING, operator: "ILIKE", column: "full_name" }
        pagination: { default_limit: 50, max_limit: 200 }
        order_by_default: "-updated_at"
    - list_accounts:
        entity: customer_accounts
        filters:
          - { name: customer_id, type: STRING, operator: "=" }
        pagination: { default_limit: 50, max_limit: 200 }
        order_by_default: "-updated_at"
